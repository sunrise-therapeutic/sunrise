<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify – Sunrise Therapeutic Riding &amp; Learning Centre</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
          rel="stylesheet">
    <style>
        .notify-section {
            background: #f9f9f9;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #00a651;
        }
        .notify-section h3 {
            color: #333;
            margin-top: 0;
        }
        .button-group {
            margin: 20px 0;
        }
        .button-group button {
            background-color: #00a651;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .button-group button:hover {
            background-color: #008842;
        }
        .button-group button.danger {
            background-color: #d9534f;
        }
        .button-group button.danger:hover {
            background-color: #c9302c;
        }
        .message-input-group {
            margin: 20px 0;
        }
        .message-input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        .message-input-group textarea {
            width: 100%;
            max-width: 500px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            box-sizing: border-box;
            min-height: 80px;
        }
        .message-input-group button {
            background-color: #00a651;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .message-input-group button:hover {
            background-color: #008842;
        }
        .confirmation-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .confirmation-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .confirmation-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>

 <!-- Header -->
 <div id="header-placeholder"></div>

 <!-- MAIN CONTENT -->
 <main class="container">

    <section class="two-column-layout">

        <!-- LEFT: Notification Control -->
        <article class="text-column">
            <h1>Post Announcement on Home Page</h1>
            <p>Use this page to:</p> 
            <ul>
                <li>Announce that all lessons and programs are cancelled today due to bad weather</li>
                <li>Post a custom message.</li>
                <li>Remove any existing cancellation notices or custom messages.</li>
            </ul>
                <p>Posts will appear in the "At Sunrise Today" section on the Home page and remain visible to the public
                    until 5am the next morning when it will automatically be replaced by the default message:
            <em>"There are no lesson or program cancellations today (current date)."</em>
                
        

            <!-- Quick Cancel Button -->
            <div class="notify-section">
                <p><b>To cancel all lessons and programs for the day</b>, click the button below:</p>
                <div class="button-group">
                   <center> <button id="cancelAllBtn">"All programs are cancelled today (today's date)<br>due to bad weather."</button></center>
                </div>
            </div>

            <!-- Confirmation Message -->
            <div class="confirmation-message" id="confirmationMsg"></div>

            <!-- Custom Message -->
            <div class="notify-section">
                <p><b>To post a custom message</b>, enter the message in the field below and click <b>Submit</b>.</p>
                <div class="message-input-group">
                    <textarea id="customMessage" placeholder="Enter your custom message here..."></textarea>
                    <button id="submitCustomBtn">Submit</button>
                </div>
            </div>

            <!-- Confirmation Message -->
            <div class="confirmation-message" id="confirmationMsg"></div>

            <!-- Remove Cancellation -->
            <div class="notify-section">
                <p><b>To immediately remove announcements or custom messages and restore the default message</b>, click the button below.</p>
                <div class="button-group">
                    <center><button id="removeCancelBtn" class="danger">Remove cancellation notice 
                        <br>or custom message</button></center>
                </div>
            </div>

            <!-- Confirmation Message -->
            <div class="confirmation-message" id="confirmationMsg"></div>

            

            
        </article>

        <!-- RIGHT: Info/Status -->
        <aside class="thumbs-column">
            <div class="notify-section">
                <h3>About This Page</h3>
                <p>
                    Instructors and Sunrise staff can use this page to post immediate program cancellation announcements that appear 
                    on the <a href="index.html">Home page</a>.
                </p>
                <p>
                    In production, these announcements will appear on the main index.html page_.
                </p>
                <p>
                    <strong>Note:</strong> Changes may take a few moments to appear on the website.
                </p>
            </div>
        </aside>

    </section>
</main>

 <!-- Footer -->
 <div id="footer-placeholder"></div>

 <script type="module">
    // Load header, then initialise the menu
    fetch('header.html')
        .then(r => r.text())
        .then(html => {
            document.getElementById('header-placeholder').innerHTML = html;
            import('./menu-2.js').then(mod => mod.initMenu());
        })
        .catch(err => console.error('Header load failed:', err));

    // Footer fetch
    fetch('footer.html')
        .then(r => r.text())
        .then(html => {
            document.getElementById('footer-placeholder').innerHTML = html;
        });

    // Notification functionality
    const confirmationMsg = document.getElementById('confirmationMsg');

    function showMessage(message, type = 'success') {
        confirmationMsg.textContent = message;
        confirmationMsg.className = `confirmation-message ${type}`;
        confirmationMsg.style.display = 'block';
        
        // Auto-hide after 45 seconds
        setTimeout(() => {
            confirmationMsg.style.display = 'none';
        }, 45000);
    }

    function triggerWorkflow(messageText) {
      // --------------------------------------------------------------
  // 1️⃣  URL of the Cloudflare Worker you deployed__
  // --------------------------------------------------------------
  // Replace <your‑account> with the sub‑domain you got from Cloudflare.
  // Example:
  //   const WORKER_URL = 'https://announcement-proxy.myaccount.workers.dev/announce';
  const WORKER_URL = 'https://sunriseupdateannounce-proxy.empty-resonance-7bcd.workers.dev/';

  // --------------------------------------------------------------
  // 2️⃣  Send the message to the worker.-
  // --------------------------------------------------------------
  fetch(WORKER_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'   // tells the worker we’re sending JSON
      // The browser automatically includes the Origin header;
      // the worker checks that against its whitelist.
    },
    body: JSON.stringify({ message: messageText })
  })
  .then(resp => {
    // The worker returns JSON { ok: true } on success (status 200)
    // or a plain‑text error with status 502/401 etc.
    if (resp.ok) {
      return resp.json().then(data => {
        if (data.ok) {
          showMessage('Your announcement has been posted, and will be visible until 5am tomorrow. It may take a few moments to appear on the website.', 'success');
        } else {
          // Unexpected shape – treat as error
          showMessage('Unexpected response from server.', 'error');
        }
      });
    } else {
      // Non‑2xx status – grab the error text for debugging
      return resp.text().then(txt => {
        showMessage('Error posting announcement – see console.', 'error');
        console.error('Worker error:', resp.status, txt);
      });
    }
  })
  .catch(err => {
    // Network problems, CORS issues, etc.
    console.error('Fetch error:', err);
    showMessage('Network error – please try again.', 'error');
  });
}

    // Cancel all programs button
    document.getElementById('cancelAllBtn').addEventListener('click', function() {
        const today = new Date().toLocaleDateString('en-US', { 
            weekday: 'short', 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
        const message = `All programs are cancelled today (${today}) due to bad weather.`;
        triggerWorkflow(message);
    });

    // Custom message submit button
    document.getElementById('submitCustomBtn').addEventListener('click', function() {
        const customMsg = document.getElementById('customMessage').value.trim();
        if (!customMsg) {
            showMessage('Please enter a message before submitting.', 'error');
            return;
        }
        triggerWorkflow(customMsg);
        document.getElementById('customMessage').value = '';
    });

    // Remove cancellation button
    document.getElementById('removeCancelBtn').addEventListener('click', function() {
        const today = new Date().toLocaleDateString('en-US', { 
            weekday: 'short', 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
        const message = `CLEAR_CANCELLATION|There are no lesson or program cancellations today (${today}).`;
        triggerWorkflow(message);
        showMessage('The cancellation notice has been removed.', 'success');
    });
 </script>
</body>
</html>
