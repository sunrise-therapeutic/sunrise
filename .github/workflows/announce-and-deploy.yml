name: Announce and Deploy in One Step

on:
  repository_dispatch:
    types: [cancellation_update]
  push:
    branches: ["main"]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Git setup
      - name: Set up git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      # 3A. Update announcement ONLY if from notify.html
      - name: Update announcement (from notify.html)
        if: github.event_name == 'repository_dispatch'
        env:
          NEW_MSG: ${{ github.event.client_payload.new_message }}
        run: |
          # Create Python script
          cat > /tmp/update.py << 'EOF'
          import sys, re
          from datetime import datetime
          
          message = sys.argv[1]
          with open('index-test.html', 'r', encoding='utf-8') as f:
              content = f.read()
          
          today = datetime.now().strftime('%a, %b %d, %Y')
          
          if message.startswith("CLEAR_CANCELLATION|"):
              new_content = f'There are no lesson or program cancellations today ({today}).'
              new_style = 'background:#d4edda;color:#155724;padding:0.5rem;text-align:center;font-weight:bold;border:1px solid #c3e6cb;border-radius:4px;margin:1rem 0;'
          else:
              new_content = message
              new_style = 'background:#f8d7da;color:#721c24;padding:0.5rem;text-align:center;font-weight:bold;border:1px solid #f5c6cb;border-radius:4px;margin:1rem 0;'
          
          pattern = r'<div id="announcement"[^>]*>.*?</div>'
          replacement = f'<div id="announcement" style="{new_style}">\n    {new_content}\n  </div>'
          content = re.sub(pattern, replacement, content, flags=re.DOTALL)
          
          with open('index-test.html', 'w', encoding='utf-8') as f:
              f.write(content)
          EOF
          
          # Run the update
          python /tmp/update.py "$NEW_MSG"
          echo "‚úÖ Updated announcement: $NEW_MSG"
      
      # 3B. Ensure valid announcement exists (for regular pushes) - FIXED VERSION
      - name: Ensure valid announcement exists
        if: github.event_name == 'push'
        run: |
          cat > /tmp/ensure_announcement.py << 'EOF'
          import re
          from datetime import datetime
          
          with open('index-test.html', 'r', encoding='utf-8') as f:
              content = f.read()
          
          today = datetime.now().strftime('%a, %b %d, %Y')
          
          pattern = r'<div id="announcement"[^>]*>(.*?)</div>'
          match = re.search(pattern, content, flags=re.DOTALL)
          
          if not match:
              # No announcement - add default
              new_style = 'background:#d4edda;color:#155724;padding:0.5rem;text-align:center;font-weight:bold;border:1px solid #c3e6cb;border-radius:4px;margin:1rem 0;'
              new_content = f'There are no lesson or program cancellations today ({today}).'
              announcement_html = f'<div id="announcement" style="{new_style}">\n    {new_content}\n  </div>'
              
              insert_point = content.find('<div class="thumbnails-container">')
              if insert_point != -1:
                  content = content[:insert_point] + announcement_html + '\n\n' + content[insert_point:]
                  print("‚úÖ Added default announcement")
              else:
                  print("‚ùå Could not find insertion point")
          else:
              # FIX: Check if group(1) exists before accessing it
              announcement_text = match.group(1) if match.group(1) else ""
              announcement_text = announcement_text.strip()
              div_html = match.group(0)
              
              # Check for empty or invalid announcements
              is_empty_red = ('background:#f8d7da' in div_html and len(announcement_text) < 10)
              has_no_text = len(announcement_text) < 5
              
              if is_empty_red or has_no_text:
                  # Fix empty/invalid announcement
                  new_style = 'background:#d4edda;color:#155724;padding:0.5rem;text-align:center;font-weight:bold;border:1px solid #c3e6cb;border-radius:4px;margin:1rem 0;'
                  new_content = f'There are no lesson or program cancellations today ({today}).'
                  replacement = f'<div id="announcement" style="{new_style}">\n    {new_content}\n  </div>'
                  content = re.sub(pattern, replacement, content, flags=re.DOTALL)
                  print("‚úÖ Fixed empty/invalid announcement")
              else:
                  print(f"‚úÖ Announcement exists: {announcement_text[:50]}...")
          
          with open('index-test.html', 'w', encoding='utf-8') as f:
              f.write(content)
          EOF
          
          python /tmp/ensure_announcement.py
      
      # 4. Commit the change (if from notify.html or if we fixed something)
      - name: Commit changes
        run: |
          git add index-test.html
          if ! git diff --cached --quiet; then
            if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
              git commit -m "üö® Announcement updated via notify.html"
            else
              git commit -m "üîß Fixed/maintained announcement during website update"
            fi
            echo "‚úÖ Changes committed"
          else
            echo "‚úÖ No changes to commit"
          fi
      
      # 5. Configure Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      # 6. Upload artifact
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
      
      # 7. Deploy to Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      # 8. Show URL
      - name: Show deployment URL
        run: |
          echo "üöÄ Deployed to: ${{ steps.deployment.outputs.page_url }}"
          echo "üìÑ Direct link to test page: ${{ steps.deployment.outputs.page_url }}index-test.html"