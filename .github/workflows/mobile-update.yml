name: Mobileâ€‘triggered page update

# â‘  This workflow can be started manually (via the API) and also from the UI if you ever need it.
on:
  workflow_dispatch:
    inputs:
      new_message:
        description: "Message to insert into the page or cancellation notice"
        required: true
        default: "Lessons are cancelled today due to bad weather"
      update_type:
        description: "Type of update: 'index' for index.html, 'index_test' for index-test.html, or 'cancellation' for cancellations.html"
        required: false
        default: "index"

jobs:
  edit-page:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ Checkout the repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ Configure git (bot identity) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # â”€â”€ Apply the change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update index-test.html announcement
        if: github.event.inputs.update_type == 'index_test'
        env:
          NEW_MSG: ${{ github.event.inputs.new_message }}
        run: |
          # Create a Python script to update index-test.html
          cat > /tmp/update_announcement.py << 'EOF'
          import sys
          import re
          from datetime import datetime
          
          message = sys.argv[1]
          
          # Read the current index-test.html
          with open('index-test.html', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Get today's date
          today = datetime.now().strftime('%a, %b %d, %Y')
          
          # Handle clear cancellation request
          if message.startswith("CLEAR_CANCELLATION|"):
              # Extract the default message from the payload
              default_msg = message.split("|", 1)[1]
              announcement_html = f'''<div style="background:#d4edda;color:#155724;padding:0.5rem;text-align:center;font-weight:bold;border:1px solid #c3e6cb;border-radius:4px;">
      {default_msg}
    </div>'''
          else:
              # This is a cancellation message, show in red/warning style
              announcement_html = f'''<div style="background:#f8d7da;color:#721c24;padding:0.5rem;text-align:center;font-weight:bold;border:1px solid #f5c6cb;border-radius:4px;">
      {message}
    </div>'''
          
          # Find and replace the announcement div content
          # Match the div and replace its content while keeping the opening and closing tags
          pattern = r'(<div id="announcement"[^>]*>\s*)(?:<!--.*?-->|<div.*?</div>)(\s*</div>)'
          replacement = r'\1' + announcement_html + r'\2'
          
          content = re.sub(pattern, replacement, content, flags=re.DOTALL)
          
          # Write back the updated content
          with open('index-test.html', 'w', encoding='utf-8') as f:
              f.write(content)
          EOF
          
          python /tmp/update_announcement.py "$NEW_MSG"

      - name: Update cancellations page
        if: github.event.inputs.update_type == 'cancellation'
        env:
          NEW_MSG: ${{ github.event.inputs.new_message }}
        run: |
          # Create a script to update cancellations.html
          cat > /tmp/update_cancellation.py << 'EOF'
          import sys
          from datetime import datetime
          
          message = sys.argv[1]
          
          # Handle clear cancellation request
          if message.startswith("CLEAR_CANCELLATION|"):
              default_msg = message.split("|", 1)[1]
              # Reset to default - store in localStorage via HTML
          else:
              default_msg = message
          
          # Read the current cancellations.html
          with open('whatshappening/cancellations.html', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # Update the localStorage script in the HTML file
          # This stores the message in browser's local storage for persistence
          new_script = f'''    // Check if there's a stored cancellation message
    function loadCancellationStatus() {{
        const cancellationArea = document.getElementById('cancellationArea');
        const storedMessage = localStorage.getItem('sunrise_cancellation_message');
        const storedTime = localStorage.getItem('sunrise_cancellation_time');
        
        if (storedMessage && storedTime) {{
            const messageTime = new Date(storedTime);
            const now = new Date();
            
            // Check if message has expired (past midnight)
            const midnight = new Date();
            midnight.setHours(24, 0, 0, 0);
            
            if (now < midnight && messageTime.getDate() === now.getDate()) {{
                // Message is still valid for today
                cancellationArea.innerHTML = `
                    <div class="cancellation-container notice">
                        <div class="cancellation-message">
                            <span class="cancellation-text">${{storedMessage}}</span>
                        </div>
                    </div>
                `;
                return;
            }} else {{
                // Message has expired, clear it
                localStorage.removeItem('sunrise_cancellation_message');
                localStorage.removeItem('sunrise_cancellation_time');
            }}
        }}
        
        // Display default message
        const today = new Date().toLocaleDateString('en-US', {{ 
            weekday: 'short', 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        }});
        cancellationArea.innerHTML = `
            <div class="cancellation-container default">
                <div class="cancellation-message">
                    <span class="default-message">There are no lesson or program cancellations today (${{today}}).</span>
                </div>
            </div>
        `;
    }}

    // On page load, set the current message
    (function() {{
        const today = new Date().toLocaleDateString('en-US', {{ 
            weekday: 'short', 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        }});
        // Store the message to be displayed
        localStorage.setItem('sunrise_cancellation_message', "{default_msg}");
        localStorage.setItem('sunrise_cancellation_time', new Date().toISOString());
    }})();

    // Load cancellation status on page load
    loadCancellationStatus();

    // Check for updates every minute
    setInterval(loadCancellationStatus, 60000);'''
          
          # Find and replace the script section
          start_marker = "    // Check if there's a stored cancellation message"
          end_marker = "    setInterval(loadCancellationStatus, 60000);"
          
          start_idx = content.find(start_marker)
          end_idx = content.find(end_marker)
          
          if start_idx != -1 and end_idx != -1:
              end_idx = content.find('\n', end_idx) + 1
              content = content[:start_idx] + new_script + content[end_idx:]
          
          # Write back the updated content
          with open('whatshappening/cancellations.html', 'w', encoding='utf-8') as f:
              f.write(content)
          EOF
          
          python /tmp/update_cancellation.py "$NEW_MSG"

      - name: Update index page
        if: github.event.inputs.update_type == 'index'
        env:
          NEW_MSG: ${{ github.event.inputs.new_message }}
        run: |
          # Example: edit index.html â€“ replace the marker with the new text
          sed -i "s|<!--UPDATE-->|${NEW_MSG}|g" index.html

      # â”€â”€ Commit & push back to the publishing branch â”€
      - name: Commit changes (index-test)
        if: github.event.inputs.update_type == 'index_test'
        run: |
          git add index-test.html
          git diff --cached --quiet || git commit -m "ðŸš¨ Cancellation notice posted via Notify page (index-test.html)"
      
      - name: Commit changes (cancellations)
        if: github.event.inputs.update_type == 'cancellation'
        run: |
          git add whatshappening/cancellations.html
          git diff --cached --quiet || git commit -m "ðŸš¨ Cancellation notice posted via Notify page"
      
      - name: Commit changes (index)
        if: github.event.inputs.update_type == 'index'
        run: |
          git add index.html
          git diff --cached --quiet || git commit -m "ðŸ”§ Mobile update via GitHub Actions"
      
      - name: Push changes
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}   # autoâ€‘generated, safe for pushes
          branch: main                                 # or the branch that powers GitHub Pages