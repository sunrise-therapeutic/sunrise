name: Update announcement via dispatch

on:
  repository_dispatch:
    types: [cancellation_update]

permissions:
  contents: write

jobs:
  update-announcement:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history for proper diffs

      - name: Set up git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Debug - List files
        run: |
          echo "Current directory:"
          pwd
          echo "Files in root:"
          ls -la
          echo "Looking for index-test.html:"
          find . -name "index-test.html" -type f

      - name: Write updater script
        run: |
          cat > /tmp/update_announcement.py << 'EOF'
          import sys, re, os
          from datetime import datetime
          
          # Payload arguments
          message = sys.argv[1]
          update_type = sys.argv[2] if len(sys.argv) > 2 else 'index_test'
          
          print(f"Updating with message: {message}")
          print(f"Update type: {update_type}")
          
          # Check if file exists
          html_file = 'index-test.html'
          if not os.path.exists(html_file):
              print(f"ERROR: {html_file} not found!")
              print(f"Current directory: {os.getcwd()}")
              sys.exit(1)
          
          # Load the current file
          with open(html_file, 'r', encoding='utf-8') as f:
              content = f.read()
          
          print(f"File size: {len(content)} characters")
          
          today = datetime.now().strftime('%a, %b %d, %Y')
          
          if message.startswith("CLEAR_CANCELLATION|"):
              new_content = f'There are no lesson or program cancellations today ({today}).'
              new_style = ('background:#d4edda;color:#155724;padding:0.5rem;'
                           'text-align:center;font-weight:bold;'
                           'border:1px solid #c3e6cb;border-radius:4px;margin:1rem 0;')
          else:
              new_content = message
              new_style = ('background:#f8d7da;color:#721c24;padding:0.5rem;'
                           'text-align:center;font-weight:bold;'
                           'border:1px solid #f5c6cb;border-radius:4px;margin:1rem 0;')
          
          pattern = r'<div id="announcement"[^>]*>.*?</div>'
          
          # Check if pattern exists
          if not re.search(pattern, content, flags=re.DOTALL):
              print("ERROR: No announcement div found in the HTML!")
              sys.exit(1)
          
          replacement = f'<div id="announcement" style="{new_style}">\n    {new_content}\n  </div>'
          content = re.sub(pattern, replacement, content, flags=re.DOTALL)
          
          # Write back
          with open(html_file, 'w', encoding='utf-8') as f:
              f.write(content)
          
          print("‚úÖ Successfully updated announcement!")
          EOF

      - name: Update announcement in index-test.html
        env:
          NEW_MSG: ${{ github.event.client_payload.new_message }}
          UPDATE_TYPE: ${{ github.event.client_payload.update_type }}
        run: |
          echo "Message received: $NEW_MSG"
          echo "Update type: $UPDATE_TYPE"
          python /tmp/update_announcement.py "$NEW_MSG" "$UPDATE_TYPE"

      - name: Show changes
        run: |
          echo "Changes made:"
          git diff index-test.html || echo "No changes detected"

      - name: Commit updated index-test.html
        run: |
          git add index-test.html
          if ! git diff --cached --quiet; then
            git commit -m "üö® Announcement updated via notify.html: ${{ github.event.client_payload.new_message }}"
            echo "‚úÖ Changes committed!"
          else
            echo "‚ö†Ô∏è No changes to commit."
          fi

      - name: Push changes
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main